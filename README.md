# metAI-THA
Take Home Assignment

## Q1. Collision Detection Methods Comparision

### AABB檢測法
範例代碼使用AABB(Axis-Aligned Bounding Box)檢測法，根據題意發想的解法:
>整個工廠多個樓層的貨物、輸送帶、貨架、設備, 需考慮三維空間而非單純平面 

1. 根據CAD, mesh或點雲得到物件所有頂點，對於一個 3D 物體的所有頂點集合 $V$ 定義 $min\ point$ 和 $max\ point$: \
   $min\ point$ (最小點): 物體在所有維度上的最小座標值。\
   $max\ point$ (最大點): 物體在所有維度上的最大座標值。
2. 將各種物件包成AABB物件以簡化問題。

---
### 碰撞判斷邏輯
利用 分離軸定理 (SAT) 的簡化版本，若兩個 AABB 在 X, Y, Z 三個軸向上均有重疊，則判定為碰撞。此法計算成本極低，僅需進行 6 次數值比較。

---
### 算法
算法分為兩個階段執行，第一階段為粗略過濾，第二階段為精確分析，以最小化運算時間。

階段一：粗略過濾 (Broad Phase - Spatial Hashing)\
使用空間雜湊 (Spatial Hashing) 技術將 3D 空間切分為網格，僅對處於相同或鄰近網格內的物件進行比對，避免了 $O(N^2)$ 所有物件的兩兩比較。

階段二：精確分析\
當 AABB 證實重疊後，系統進一步取得干涉形狀。\
Intersection AABB：計算兩個盒子重疊產生的具體空間範圍。\
Voxel Sampling：在重疊區域內進行體素化採樣。\
干涉指標：透過計算活體素（Active Voxels）數量，得出精確的干涉體積。

---
### 模擬結果分析
此範例生成了500個隨機物件以及2個必定相撞的驗證用物件 (hash id 998 & 999)

```
--- 1. Generating Scene ---
Generated 502 objects.

--- 2. Broad Phase (Spatial Hash) ---
Broad Key Construction time: 0.0036s
Found 414 candidate pairs.

--- 3. Narrow Phase (AABB Check + Voxelization) ---
Narrow Phase time: 0.0030s
Confirmed 20 collisions.

--- 4. Report ---
Obj A  | Obj B  | Inter Vol  | Voxel Count
---------------------------------------------
337    | 426    | 15.00      | 15        
100    | 444    | 8.00       | 8         
195    | 308    | 8.00       | 8         
214    | 433    | 2.00       | 2         
41     | 483    | 14.00      | 14        
175    | 432    | 6.00       | 6         
998    | 999    | 500.00     | 500       <-----必定相撞的物件以及相撞的面積
17     | 363    | 70.00      | 70        
298    | 465    | 12.00      | 12        
43     | 467    | 16.00      | 16        
... and 10 more.

[Verification] Manual pair (998, 999) found! Volume: 500.00 (Expected ~500.0)
```
---
### 檢測方法比較
AABB檢測法優點是運算快，缺點是虛報多，如果有一個在空間中斜放的細長物件 (ex: 輸送帶, 長竿)，AABB 會是一個巨大的立方體，其中 90% 的空間是空的。如果旁邊有另一個物體靠近，AABB 會判定碰撞，但實際零件根本沒碰到。

單純加速AABB可以使用multithreading或是切分所有碰撞物件對，並使用GPU平行運算。

其他方式:

**BVH (Bounding Volume Hierarchy)** \
定義：這是一種「由下而上」或「由上而下」建構的物件層級樹狀結構。它將物體依照幾何位置不斷地包裝成更大的盒子。

運作邏輯：\
最底層（葉子節點）是物體本身的 AABB。上一層節點是包住下方所有子節點的大 AABB。最終形成一個樹狀結構，樹根包住整個場景。

適合場景：\
複雜且精密的物體：如一台擁有上萬個零件的引擎，或複雜的管線系統。
碰撞檢測效能優化：當你只想檢查「這台車有沒有撞到牆」，你可以先檢查車子的根 AABB，如果沒撞，就直接跳過整台車幾萬個三角形。

缺點：如果物體內部零件會頻繁移動，BVH 需要不斷重新計算層級，運算成本較高。

**Octree (八叉樹)** \
定義：這是一種「由上而下」的空間分割結構。它不是包住物體，而是直接「切碎空間」。

運作邏輯：\
將整個 3D 空間切成 8 個子空間（立方體）。如果某個子空間內物體太多，就繼續往下切 8 份。形成一個深度不一的樹，物體被歸類到所在的空間節點中。

適合場景：\
大規模固定場域：如整個工廠的多層樓。它能幫你快速定位某個座標附近有哪些物體。

稀疏空間：當場景很大但物體集中在某些區域時，Octree 能有效節省記憶體。

缺點：如果物體跨越了切割線，它必須同時存在於多個節點中，處理邏輯較複雜。

## Q2. 公車路線與站點設置規劃
* 你如何將這個問題建模成數學／演算法問題？
  1. 圖論問題，假設城市地圖已經離散化為一張圖 $G = (V, E)$
  2. 輸入參數：
     * $G(V, E)$：城市路網，每條邊 $e_{ij}$ 有距離權重 $w_{ij}$。禁區即為不可通行的節點或邊。
     * $P = {p_1, ..., p_n}$：乘客集合，每個乘客有座標。
     * $A, B \in V$：起點與終點。
     * $C_{route}$：路徑每單位的營運成本權重。
     * $C_{stop\ base}$：設站固定成本， $C_{terrain}(v)$ ：地點 $v$ 的地形加成成本。
     * $C_{walk}$：乘客步行每單位的成本權重。
  3. 決策變數 (Decision Variables)：
     * $x_{ij} \in {0, 1}$：是否經過邊 $(i, j)$（建構公車路線）。
     * $y_v \in {0, 1}$：是否在節點 $v$ 設立站牌。
     * $z_{vk} \in {0, 1}$：乘客 $p_k$ 是否被分配到站牌 $v$ 服務。
  4. 目標函數：\
     我們希望最小化總成本 $J$ \
     $$\text{Minimize } J = C_{route} \sum_{(i,j) \in E} w_{ij} x_{ij} + \sum_{v \in V} y_v (C_{stop\ base} + C_{terrain}(v)) + C_{walk} \sum_{k=1}^{n} \sum_{v \in V} z_{vk} \cdot \text{dist}(p_k, v)$$

     **路線營運成本**： $C_{route} \sum w_{ij} x_{ij}$ \
     反映車輛行駛距離與能耗，其中 $w_{ij}$ 為路段權重， $x_{ij}$ 為決策變數。\
     **站點建設成本**： $\sum y_v (C_{stop\_base} + C_{terrain}(v))$ \
     包含基礎建設固定成本與當地地形加成。\
     **乘客步行成本**： $C_{walk} \sum \sum z_{vk} \cdot \text{dist}(p_k, v)$ \
     衡量使用者便利性，計算乘客 $p_k$ 到最近站點 $v$ 的總步行距離。
* 若要設計自動找出最佳路線與站點組合的系統，你會採用什麼策略或演算法？若有多種可能的做法也請列出並且比較優缺點與適用情境。

  可能可以使用兩階段算法，clustering + pathfinding。
  
  步驟：
  
  **候選點生成 (Clustering)**：不考慮路線，先找出對於乘客群最有利的站點位置。使用 K-Means 或 DBSCAN 對乘客位置進行分群，找出群集中心作為「候選站點」。
  
  **站點評估**：計算每個候選站點的建設成本與乘客步行成本總和（局部最佳解）。
  
  **路徑規劃**：從 $A$ 出發，選擇通過部分高價值的候選站點，最後到達 $B$。
  
   * 可以使用找最短路徑的A* 演算法，將狀態定義為 (目前位置, 已覆蓋的乘客群集狀態)。
   * 或者簡化為：選取 Top-K 個高分站點，強迫經過它們，使用 Dijkstra 串接。\
**優點**：速度快，邏輯易解釋，適合地圖大、乘客多的場景。\
**缺點**：因為將選站與選路分開，可能錯過全域最佳解（例如：某個站點稍微偏離乘客中心，但能大幅縮短公車路線）。
  
